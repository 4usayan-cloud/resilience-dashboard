<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>National Resilience Dashboard 2019-2030 (Optimized)</title>
    
    <!-- PERFORMANCE: Preconnect to external resources -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cartodb-basemaps-a.global.ssl.fastly.net" crossorigin>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #loading-status {
            margin-top: 20px;
            font-size: 16px;
            text-align: center;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: none; /* Hidden until data loads */
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }
        
        header h1 {
            font-size: 42px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        header p {
            font-size: 18px;
            opacity: 0.95;
        }
        
        .header-meta {
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .header-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            padding: 0 40px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .tab {
            padding: 18px 35px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #6b7280;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .tab.active {
            color: #667eea;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }
        
        .view {
            display: none;
            padding: 40px;
        }
        
        .view.active {
            display: block;
        }
        
        #map {
            height: 600px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .control-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .control-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .info-panel {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .info-panel h2 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card .label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }
        
        .legend {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 8px;
        }
        
        /* News and Social Media Feed Styling */
        #reddit-feed a:hover, #inshorts-feed a:hover, #bbc-feed a:hover {
            text-decoration: underline;
        }
        
        #reddit-feed > div:hover, #inshorts-feed > div:hover, #bbc-feed > div:hover {
            background: #f9fafb;
            cursor: pointer;
        }
        
        .header-meta {
            margin-top: 15px;
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .header-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        footer {
            background: #1f2937;
            color: #9ca3af;
            padding: 25px 40px;
            text-align: center;
            font-size: 14px;
        }
        
        footer strong {
            color: #fff;
            font-size: 16px;
        }
        
        footer a {
            color: #667eea;
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        footer code {
            background: #374151;
            padding: 4px 10px;
            border-radius: 4px;
            color: #10b981;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <div id="loading-status">Loading dashboard data...</div>
    </div>

    <div class="container">
        <header>
            <h1>üåç National Resilience Dashboard</h1>
            <p>Comprehensive Analysis of National Resilience Indicators (2019-2030)</p>
            <div class="header-meta">
                <span>¬© 2024-2026 Sayan Sen</span>
                <span>|</span>
                <span>üåê <strong>IST:</strong> <span id="time-ist"></span></span>
                <span>|</span>
                <span>üóæ <strong>Tokyo:</strong> <span id="time-tokyo"></span></span>
                <span>|</span>
                <span>ü¶ò <strong>Sydney:</strong> <span id="time-sydney"></span></span>
                <span>|</span>
                <span>üá∫üá∏ <strong>EST:</strong> <span id="time-est"></span></span>
                <span>|</span>
                <span>üü¢ Live Data API Active</span>
            </div>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="switchView('map')">üó∫Ô∏è Map View</button>
            <button class="tab" onclick="switchView('country')">üìä Country Analysis</button>
            <button class="tab" onclick="switchView('trends')">üìà Trends</button>
            <button class="tab" onclick="switchView('rankings')">üèÜ Rankings</button>
            <button class="tab" onclick="switchView('violence')">‚ö†Ô∏è Violence Tracker</button>
            <button class="tab" onclick="switchView('social')">üì± Social Media</button>
            <button class="tab" onclick="switchView('news')">üì∞ Live News</button>
            <button class="tab" onclick="switchView('methodology')">üìñ Methodology</button>
        </div>
        
        <div id="map-view" class="view active">
            <div class="controls">
                <div class="control-group">
                    <label for="year-select">Year</label>
                    <select id="year-select" onchange="updateVisualization()"></select>
                </div>
                <div class="control-group">
                    <label for="indicator-select">Indicator</label>
                    <select id="indicator-select" onchange="updateVisualization()">
                        <option value="overall">Overall Resilience</option>
                        <option value="financial">Financial Resilience</option>
                        <option value="social">Social Resilience</option>
                        <option value="institutional">Institutional Resilience</option>
                        <option value="infrastructure">Infrastructure Resilience</option>
                    </select>
                </div>
            </div>
            
            <div id="map"></div>
            
            <div class="info-panel">
                <h2>Selected Country: <span id="selected-country">None</span></h2>
                <div class="stats-grid" id="country-stats"></div>
            </div>
        </div>
        
        <div id="country-view" class="view">
            <div class="controls">
                <div class="control-group">
                    <label for="analysis-country">Select Country</label>
                    <select id="analysis-country" onchange="updateCountryAnalysis()"></select>
                </div>
                <div class="control-group">
                    <label for="analysis-year">Year</label>
                    <select id="analysis-year" onchange="updateCountryAnalysis()"></select>
                </div>
            </div>
            
            <div class="info-panel">
                <h2 id="analysis-country-name">Select a Country</h2>
                
                <div class="stats-grid" id="analysis-stats"></div>
                
                <h3 style="margin-top: 30px; margin-bottom: 20px;">Individual Pillar Performance</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px;">
                    <div class="info-panel" style="padding: 20px;">
                        <h4 style="color: #667eea; margin-bottom: 15px;">üí∞ Financial Resilience</h4>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="financial-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="info-panel" style="padding: 20px;">
                        <h4 style="color: #10b981; margin-bottom: 15px;">üë• Social Resilience</h4>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="social-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="info-panel" style="padding: 20px;">
                        <h4 style="color: #f59e0b; margin-bottom: 15px;">üèõÔ∏è Institutional Resilience</h4>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="institutional-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="info-panel" style="padding: 20px;">
                        <h4 style="color: #8b5cf6; margin-bottom: 15px;">üèóÔ∏è Infrastructure Resilience</h4>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="infrastructure-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        
        <!-- Social Media Feed View -->
        <div id="social-view" class="view">
            <div style="padding: 30px;">
                <h2 style="color: #667eea; margin-bottom: 25px; border-bottom: 3px solid #667eea; padding-bottom: 10px;">
                    üì± Live Social Media Feeds
                </h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <!-- Reddit Feed -->
                    <div class="info-panel" style="padding: 20px;">
                        <h3 style="color: #ff4500; margin-bottom: 15px;">üî¥ Reddit - World News</h3>
                        <div id="reddit-feed" style="max-height: 400px; overflow-y: auto;">
                            <div class="spinner" style="width: 30px; height: 30px; margin: 20px auto;"></div>
                        </div>
                    </div>
                    
                    <!-- YouTube Feed -->
                    <div class="info-panel" style="padding: 20px;">
                        <h3 style="color: #ff0000; margin-bottom: 15px;">‚ñ∂Ô∏è YouTube - Top News</h3>
                        <div id="youtube-feed" style="max-height: 400px; overflow-y: auto;">
                            <p style="color: #666; font-size: 14px;">YouTube API requires authentication key.<br>Add your API key in the configuration.</p>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                    <!-- X (Twitter) Feed -->
                    <div class="info-panel" style="padding: 20px;">
                        <h3 style="color: #1da1f2; margin-bottom: 15px;">ùïè X (Twitter) - Trending</h3>
                        <div id="twitter-feed" style="max-height: 400px; overflow-y: auto;">
                            <p style="color: #666; font-size: 14px;">X API requires authentication tokens.<br>Add your credentials in the configuration.</p>
                        </div>
                    </div>
                    
                    <!-- Instagram Feed -->
                    <div class="info-panel" style="padding: 20px;">
                        <h3 style="color: #e4405f; margin-bottom: 15px;">üì∏ Instagram - Popular</h3>
                        <div id="instagram-feed" style="max-height: 400px; overflow-y: auto;">
                            <p style="color: #666; font-size: 14px;">Instagram API requires authentication.<br>Add your access token in the configuration.</p>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">‚öôÔ∏è API Configuration</h4>
                    <p style="font-size: 14px; color: #666; line-height: 1.8;">
                        To enable social media feeds, you need to configure API credentials:<br>
                        ‚Ä¢ <strong>Reddit:</strong> No authentication required (using public JSON API)<br>
                        ‚Ä¢ <strong>YouTube:</strong> Get API key from <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a><br>
                        ‚Ä¢ <strong>X (Twitter):</strong> Get bearer token from <a href="https://developer.twitter.com/" target="_blank">Twitter Developer Portal</a><br>
                        ‚Ä¢ <strong>Instagram:</strong> Get access token from <a href="https://developers.facebook.com/" target="_blank">Meta Developers</a>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Live News Feed View -->
        <div id="news-view" class="view">
            <div style="padding: 30px;">
                <h2 style="color: #667eea; margin-bottom: 25px; border-bottom: 3px solid #667eea; padding-bottom: 10px;">
                    üì∞ Live News Feeds
                </h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px;">
                    <!-- Ground News -->
                    <div class="info-panel" style="padding: 25px;">
                        <h3 style="color: #2563eb; margin-bottom: 15px;">üåç Ground News - Global Coverage</h3>
                        <div id="groundnews-feed" style="max-height: 500px; overflow-y: auto;">
                            <div class="spinner" style="width: 30px; height: 30px; margin: 20px auto;"></div>
                        </div>
                    </div>
                    
                    <!-- Inshorts -->
                    <div class="info-panel" style="padding: 25px;">
                        <h3 style="color: #ff6b35; margin-bottom: 15px;">‚ö° Inshorts - Quick Updates</h3>
                        <div id="inshorts-feed" style="max-height: 500px; overflow-y: auto;">
                            <div class="spinner" style="width: 30px; height: 30px; margin: 20px auto;"></div>
                        </div>
                    </div>
                    
                    <!-- NewsAPI -->
                    <div class="info-panel" style="padding: 25px;">
                        <h3 style="color: #10b981; margin-bottom: 15px;">üì° NewsAPI - Top Headlines</h3>
                        <div id="newsapi-feed" style="max-height: 500px; overflow-y: auto;">
                            <div class="spinner" style="width: 30px; height: 30px; margin: 20px auto;"></div>
                        </div>
                    </div>
                    
                    <!-- RSS World News -->
                    <div class="info-panel" style="padding: 25px;">
                        <h3 style="color: #8b5cf6; margin-bottom: 15px;">üîî BBC World News</h3>
                        <div id="bbc-feed" style="max-height: 500px; overflow-y: auto;">
                            <div class="spinner" style="width: 30px; height: 30px; margin: 20px auto;"></div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">üìä Available News Sources</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; font-size: 14px;">
                        <div>
                            <strong>‚úÖ Free APIs (No Auth):</strong><br>
                            ‚Ä¢ Inshorts API<br>
                            ‚Ä¢ RSS2JSON (BBC, Reuters)<br>
                            ‚Ä¢ NewsData.io (Free tier)
                        </div>
                        <div>
                            <strong>üîë API Key Required:</strong><br>
                            ‚Ä¢ NewsAPI.org (100 req/day free)<br>
                            ‚Ä¢ Ground News API<br>
                            ‚Ä¢ The Guardian API
                        </div>
                        <div>
                            <strong>üåê RSS Feeds:</strong><br>
                            ‚Ä¢ BBC World<br>
                            ‚Ä¢ Reuters<br>
                            ‚Ä¢ Al Jazeera
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Violence Tracker View -->
        <div id="violence-view" class="view">
            <div style="padding: 30px;">
                <h2 style="color: #ef4444; margin-bottom: 25px; border-bottom: 3px solid #ef4444; padding-bottom: 10px;">
                    ‚ö†Ô∏è Social Violence Tracker - Communal, Racial & Hate Crimes
                </h2>
                
                <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">üìä Violence Data Integration</h3>
                    <p style="line-height: 1.8; opacity: 0.95;">
                        This section tracks communal violence, racial discrimination, hate crimes, and social cohesion indicators across all countries. Lower scores indicate higher violence and discrimination. Data is sourced from ACLED, UN CERD, OSCE ODIHR, and World Bank.
                    </p>
                </div>
                
                <div class="controls" style="margin-bottom: 30px;">
                    <div class="control-group">
                        <label for="violence-country-select">Select Country</label>
                        <select id="violence-country-select" onchange="updateViolenceData()"></select>
                    </div>
                    <div class="control-group">
                        <label for="violence-year-select">Select Year</label>
                        <select id="violence-year-select" onchange="updateViolenceData()"></select>
                    </div>
                </div>
                
                <!-- Violence Indicators Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="info-panel" style="padding: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
                        <h4 style="color: #92400e; margin-bottom: 10px;">üî• Communal Violence</h4>
                        <div style="font-size: 36px; font-weight: 700; color: #92400e;" id="communal-violence-score">--</div>
                        <p style="font-size: 12px; color: #78350f; margin-top: 10px;">Incidents per 100k population (inverted)</p>
                    </div>
                    
                    <div class="info-panel" style="padding: 20px; background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);">
                        <h4 style="color: #9f1239; margin-bottom: 10px;">‚öñÔ∏è Racial Equality</h4>
                        <div style="font-size: 36px; font-weight: 700; color: #9f1239;" id="racial-equality-score">--</div>
                        <p style="font-size: 12px; color: #881337; margin-top: 10px;">Discrimination index (0-1, higher is better)</p>
                    </div>
                    
                    <div class="info-panel" style="padding: 20px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
                        <h4 style="color: #1e40af; margin-bottom: 10px;">ü§ù Social Cohesion</h4>
                        <div style="font-size: 36px; font-weight: 700; color: #1e40af;" id="social-cohesion-score">--</div>
                        <p style="font-size: 12px; color: #1e3a8a; margin-top: 10px;">Community trust & inter-group relations</p>
                    </div>
                    
                    <div class="info-panel" style="padding: 20px; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
                        <h4 style="color: #991b1b; margin-bottom: 10px;">‚ö†Ô∏è Hate Crimes</h4>
                        <div style="font-size: 36px; font-weight: 700; color: #991b1b;" id="hate-crime-score">--</div>
                        <p style="font-size: 12px; color: #7f1d1d; margin-top: 10px;">Reported incidents (inverted scale)</p>
                    </div>
                </div>
                
                <!-- Violence Trends Chart -->
                <div class="info-panel" style="padding: 25px; margin-bottom: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">üìà Violence Indicators Timeline (2019-2030)</h3>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="violence-trends-chart"></canvas>
                    </div>
                </div>
                
                <!-- Live Violence Data Feeds -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="info-panel" style="padding: 25px;">
                        <h3 style="color: #ef4444; margin-bottom: 15px;">üåç ACLED - Conflict Events</h3>
                        <div id="acled-feed" style="max-height: 400px; overflow-y: auto;">
                            <div style="padding: 20px; text-align: center; color: #666;">
                                <p style="margin-bottom: 15px;">ACLED tracks political violence and protest events worldwide.</p>
                                <p style="font-size: 13px; line-height: 1.8;">
                                    <strong>Data Source:</strong> <a href="https://acleddata.com/" target="_blank" style="color: #667eea;">acleddata.com</a><br>
                                    <strong>Coverage:</strong> 190+ countries<br>
                                    <strong>Update Frequency:</strong> Weekly<br>
                                    <strong>API:</strong> Free registration required
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-panel" style="padding: 25px;">
                        <h3 style="color: #dc2626; margin-bottom: 15px;">üìä UN Human Rights Data</h3>
                        <div id="unhrc-feed" style="max-height: 400px; overflow-y: auto;">
                            <div style="padding: 20px; text-align: center; color: #666;">
                                <p style="margin-bottom: 15px;">UN Committee on Elimination of Racial Discrimination reports.</p>
                                <p style="font-size: 13px; line-height: 1.8;">
                                    <strong>Data Source:</strong> <a href="https://www.ohchr.org/en/treaty-bodies/cerd" target="_blank" style="color: #667eea;">UN CERD</a><br>
                                    <strong>Coverage:</strong> 180+ countries<br>
                                    <strong>Reports:</strong> Country-specific reviews<br>
                                    <strong>API:</strong> Open data portal available
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Sources Information -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 10px;">
                    <h4 style="color: #667eea; margin-bottom: 20px;">üìã Violence Data Sources & Indicators</h4>
                    
                    <div style="display: grid; gap: 20px;">
                        <div style="border-left: 4px solid #f59e0b; padding-left: 20px;">
                            <h5 style="color: #92400e; margin-bottom: 10px;">üî• Communal Violence Index</h5>
                            <p style="font-size: 14px; color: #4b5563; line-height: 1.8;">
                                <strong>Source:</strong> <a href="https://acleddata.com/" target="_blank">ACLED</a> (Armed Conflict Location & Event Data Project)<br>
                                <strong>Measures:</strong> Riots, communal clashes, ethnic violence, mob attacks<br>
                                <strong>Calculation:</strong> Incidents per 100,000 population, inverted and normalized (0-1)<br>
                                <strong>Note:</strong> Higher scores indicate lower violence
                            </p>
                        </div>
                        
                        <div style="border-left: 4px solid #ec4899; padding-left: 20px;">
                            <h5 style="color: #9f1239; margin-bottom: 10px;">‚öñÔ∏è Racial Equality Index</h5>
                            <p style="font-size: 14px; color: #4b5563; line-height: 1.8;">
                                <strong>Source:</strong> <a href="https://www.ohchr.org/en/treaty-bodies/cerd" target="_blank">UN CERD</a> & <a href="https://www.worldvaluessurvey.org/" target="_blank">World Values Survey</a><br>
                                <strong>Measures:</strong> Discrimination in employment, education, housing, justice system<br>
                                <strong>Calculation:</strong> Composite of legal protections and lived experiences<br>
                                <strong>Coverage:</strong> 180+ countries with periodic reviews
                            </p>
                        </div>
                        
                        <div style="border-left: 4px solid #3b82f6; padding-left: 20px;">
                            <h5 style="color: #1e40af; margin-bottom: 10px;">ü§ù Social Cohesion Score</h5>
                            <p style="font-size: 14px; color: #4b5563; line-height: 1.8;">
                                <strong>Source:</strong> <a href="https://www.worldbank.org/en/topic/fragilityconflictviolence" target="_blank">World Bank</a> & <a href="https://www.socialcohesion.info/" target="_blank">Social Cohesion Research Network</a><br>
                                <strong>Measures:</strong> Trust levels, social networks, inter-group contact, community participation<br>
                                <strong>Calculation:</strong> Survey-based index of bonding, bridging, and linking social capital<br>
                                <strong>Range:</strong> 0 (low cohesion) to 1 (high cohesion)
                            </p>
                        </div>
                        
                        <div style="border-left: 4px solid #ef4444; padding-left: 20px;">
                            <h5 style="color: #991b1b; margin-bottom: 10px;">‚ö†Ô∏è Hate Crime Index</h5>
                            <p style="font-size: 14px; color: #4b5563; line-height: 1.8;">
                                <strong>Source:</strong> <a href="https://www.osce.org/odihr/hate-crime-reporting" target="_blank">OSCE ODIHR</a> & National Crime Statistics<br>
                                <strong>Measures:</strong> Crimes motivated by race, religion, ethnicity, sexual orientation<br>
                                <strong>Calculation:</strong> Reported incidents per capita, adjusted for reporting quality, inverted<br>
                                <strong>Note:</strong> Includes both official statistics and NGO-reported incidents
                            </p>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <h5 style="color: #dc2626; margin-bottom: 15px;">‚ö†Ô∏è Data Limitations & Context</h5>
                        <ul style="font-size: 14px; color: #4b5563; line-height: 2; padding-left: 20px;">
                            <li><strong>Reporting Bias:</strong> Countries with better systems may show higher reported rates</li>
                            <li><strong>Definition Variance:</strong> What constitutes hate crime varies by jurisdiction</li>
                            <li><strong>Underreporting:</strong> Many incidents go unreported due to fear or lack of trust</li>
                            <li><strong>Data Gaps:</strong> Not all countries collect or share comprehensive data</li>
                            <li><strong>Projections:</strong> 2024-2030 estimates based on trends and expert analysis</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="trends-view" class="view">
            <div class="controls">
                <div class="control-group">
                    <label for="country-select">Select Country</label>
                    <select id="country-select" onchange="updateTrends()"></select>
                </div>
            </div>
            
            <div class="info-panel">
                <h2>Resilience Trends Over Time</h2>
                <div class="chart-container">
                    <canvas id="trends-chart"></canvas>
                </div>
            </div>
        </div>
        
        <div id="methodology-view" class="view">
            <div id="methodology-content"></div>
        </div>
        
        <div id="rankings-view" class="view">
            <div class="controls">
                <div class="control-group">
                    <label for="ranking-year">Year</label>
                    <select id="ranking-year" onchange="updateRankings()"></select>
                </div>
                <div class="control-group">
                    <label for="ranking-indicator">Indicator</label>
                    <select id="ranking-indicator" onchange="updateRankings()">
                        <option value="overall">Overall Resilience</option>
                        <option value="financial">Financial Resilience</option>
                        <option value="social">Social Resilience</option>
                        <option value="institutional">Institutional Resilience</option>
                        <option value="infrastructure">Infrastructure Resilience</option>
                    </select>
                </div>
            </div>
            
            <div class="info-panel">
                <h2>Top 20 Countries</h2>
                <div id="rankings-list"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let RESILIENCE_DATA = null;
        let WORLD_GEOJSON = null;
        let map = null;
        let geoJsonLayer = null;
        let trendsChart = null;
        
        // Load data from separate JSON files with caching
        async function loadData() {
            const loadingStatus = document.getElementById('loading-status');
            
            try {
                // Check cache first (only resilience data is cached)
                const cached = getCachedData();
                if (cached && cached.resilience) {
                    RESILIENCE_DATA = cached.resilience;
                    loadingStatus.textContent = 'Loading map data...';
                    // Still need to load GeoJSON
                    const geojsonResponse = await fetch('data/world_geojson.json');
                    WORLD_GEOJSON = await geojsonResponse.json();
                    loadingStatus.textContent = 'Data loaded from cache!';
                    return;
                }
                
                // Load resilience data
                loadingStatus.textContent = 'Loading country data...';
                const resilienceResponse = await fetch('data/resilience_data.json');
                RESILIENCE_DATA = await resilienceResponse.json();
                
                // Load GeoJSON data
                loadingStatus.textContent = 'Loading map data...';
                const geojsonResponse = await fetch('data/world_geojson.json');
                WORLD_GEOJSON = await geojsonResponse.json();
                
                // Cache the data
                setCachedData({ resilience: RESILIENCE_DATA, geojson: WORLD_GEOJSON });
                
                loadingStatus.textContent = 'Data loaded successfully!';
            } catch (error) {
                console.error('Error loading data:', error);
                loadingStatus.textContent = 'Error loading data: ' + error.message;
                loadingStatus.style.color = '#ff4444';
            }
        }
        
        // Cache management (5 minutes TTL) - Only caches resilience data, not GeoJSON
        function getCachedData() {
            try {
                const cached = localStorage.getItem('dashboard_cache');
                if (!cached) return null;
                
                const { data, timestamp } = JSON.parse(cached);
                const now = Date.now();
                const fiveMinutes = 5 * 60 * 1000;
                
                if (now - timestamp < fiveMinutes && data.resilience) {
                    console.log('Using cached resilience data (GeoJSON will load separately)');
                    return data;
                }
                
                localStorage.removeItem('dashboard_cache');
                return null;
            } catch (e) {
                console.error('Cache error:', e);
                try { localStorage.removeItem('dashboard_cache'); } catch(ex) {}
                return null;
            }
        }
        
        function setCachedData(data) {
            try {
                // Only cache resilience data (445KB), not GeoJSON (13MB) to avoid quota
                const cacheObj = {
                    data: { resilience: data.resilience }, // Skip geojson
                    timestamp: Date.now()
                };
                localStorage.setItem('dashboard_cache', JSON.stringify(cacheObj));
                console.log('Resilience data cached successfully (GeoJSON excluded)');
            } catch (e) {
                console.error('Failed to cache data:', e);
                // Clear cache if quota exceeded
                try { localStorage.removeItem('dashboard_cache'); } catch(ex) {}
            }
        }
        
        // Initialize dashboard after data loads
        async function initializeDashboard() {
            await loadData();
            
            if (!RESILIENCE_DATA || !WORLD_GEOJSON) {
                console.error('Failed to load required data');
                return;
            }
            
            // Hide loading screen, show dashboard
            document.getElementById('loading-screen').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
            
            // Initialize map
            initializeMap();
            
            // Populate controls
            populateYearSelects();
            populateCountrySelect();
            populateAnalysisSelects();
            
            // Initial visualization
            updateVisualization();
        }
        
        // Initialize Leaflet map with canvas renderer
        function initializeMap() {
            map = L.map('map', {
                center: [20, 0],
                zoom: 2,
                preferCanvas: true
            });
            
            L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                maxZoom: 18
            }).addTo(map);
        }
        
        // Populate year selectors
        function populateYearSelects() {
            const years = ['2019', '2020', '2021', '2022', '2023', '2024', '2025', '2026', '2027', '2028', '2029', '2030'];
            
            const yearSelect = document.getElementById('year-select');
            const rankingYear = document.getElementById('ranking-year');
            
            years.forEach(year => {
                yearSelect.add(new Option(year, year));
                rankingYear.add(new Option(year, year));
            });
            
            yearSelect.value = '2024';
            rankingYear.value = '2024';
        }
        
        // Populate country selector
        function populateCountrySelect() {
            const countrySelect = document.getElementById('country-select');
            
            RESILIENCE_DATA
                .filter(country => country.name && country.name !== '')
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(country => {
                    countrySelect.add(new Option(country.name, country.iso3));
                });
            
            countrySelect.value = RESILIENCE_DATA[0].iso3;
        }
        
        // Populate analysis selectors
        function populateAnalysisSelects() {
            const analysisCountry = document.getElementById('analysis-country');
            const analysisYear = document.getElementById('analysis-year');
            
            const years = ['2019', '2020', '2021', '2022', '2023', '2024', '2025', '2026', '2027', '2028', '2029', '2030'];
            
            RESILIENCE_DATA
                .filter(country => country.name && country.name !== '')
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(country => {
                    analysisCountry.add(new Option(country.name, country.iso3));
                });
            
            years.forEach(year => {
                analysisYear.add(new Option(year, year));
            });
            
            analysisCountry.value = RESILIENCE_DATA[0].iso3;
            analysisYear.value = '2024';
        }
        
        // Update map visualization
        let updateTimeout;
        function updateVisualization() {
            // Debounce to prevent excessive updates
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                const year = document.getElementById('year-select').value;
                const indicator = document.getElementById('indicator-select').value;
                
                if (geoJsonLayer) {
                    map.removeLayer(geoJsonLayer);
                }
                
                geoJsonLayer = L.geoJSON(WORLD_GEOJSON, {
                    style: feature => styleCountry(feature, year, indicator),
                    onEachFeature: (feature, layer) => {
                        layer.on({
                            click: () => selectCountry(feature.properties['ISO3166-1-Alpha-3'])
                        });
                    }
                }).addTo(map);
            }, 100);
        }
        
        // Style countries based on resilience score
        function styleCountry(feature, year, indicator) {
            const iso3 = feature.properties['ISO3166-1-Alpha-3'];
            const countryData = RESILIENCE_DATA.find(c => c.iso3 === iso3);
            
            if (!countryData || !countryData.timeline || !countryData.timeline[year]) {
                return {
                    fillColor: '#cccccc',
                    fillOpacity: 0.3,
                    color: '#999999',
                    weight: 1
                };
            }
            
            const value = countryData.timeline[year][indicator];
            const color = getColorForValue(value);
            
            return {
                fillColor: color,
                fillOpacity: 0.7,
                color: '#ffffff',
                weight: 1
            };
        }
        
        // Get color based on resilience value
        function getColorForValue(value) {
            if (value >= 0.8) return '#10b981'; // Green
            if (value >= 0.6) return '#fbbf24'; // Yellow
            if (value >= 0.4) return '#f97316'; // Orange
            return '#ef4444'; // Red
        }
        
        // Select and display country data
        function selectCountry(iso3) {
            const countryData = RESILIENCE_DATA.find(c => c.iso3 === iso3);
            
            if (!countryData) return;
            
            const year = document.getElementById('year-select').value;
            const yearData = countryData.timeline[year];
            
            document.getElementById('selected-country').textContent = countryData.name || iso3;
            
            const statsContainer = document.getElementById('country-stats');
            statsContainer.innerHTML = '';
            
            if (yearData) {
                const indicators = [
                    { key: 'overall', label: 'Overall' },
                    { key: 'financial', label: 'Financial' },
                    { key: 'social', label: 'Social' },
                    { key: 'institutional', label: 'Institutional' },
                    { key: 'infrastructure', label: 'Infrastructure' }
                ];
                
                indicators.forEach(ind => {
                    const value = yearData[ind.key];
                    if (value !== undefined) {
                        statsContainer.innerHTML += `
                            <div class="stat-card">
                                <div class="label">${ind.label} Resilience</div>
                                <div class="value">${(value * 100).toFixed(1)}%</div>
                            </div>
                        `;
                    }
                });
            }
        }
        
        // Update trends chart
        function updateTrends() {
            const iso3 = document.getElementById('country-select').value;
            const countryData = RESILIENCE_DATA.find(c => c.iso3 === iso3);
            
            if (!countryData) return;
            
            const years = Object.keys(countryData.timeline).sort();
            const datasets = [
                {
                    label: 'Overall',
                    data: years.map(y => countryData.timeline[y].overall),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)'
                },
                {
                    label: 'Financial',
                    data: years.map(y => countryData.timeline[y].financial),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)'
                },
                {
                    label: 'Social',
                    data: years.map(y => countryData.timeline[y].social),
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)'
                },
                {
                    label: 'Institutional',
                    data: years.map(y => countryData.timeline[y].institutional),
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)'
                },
                {
                    label: 'Infrastructure',
                    data: years.map(y => countryData.timeline[y].infrastructure),
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)'
                }
            ];
            
            if (trendsChart) {
                trendsChart.destroy();
            }
            
            const ctx = document.getElementById('trends-chart').getContext('2d');
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: countryData.name || iso3
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });
        }
        
        // Update rankings
        function updateRankings() {
            const year = document.getElementById('ranking-year').value;
            const indicator = document.getElementById('ranking-indicator').value;
            
            const rankings = RESILIENCE_DATA
                .filter(c => c.timeline && c.timeline[year] && c.timeline[year][indicator] !== undefined)
                .map(c => ({
                    name: c.name || c.iso3,
                    value: c.timeline[year][indicator]
                }))
                .sort((a, b) => b.value - a.value)
                .slice(0, 20);
            
            const rankingsList = document.getElementById('rankings-list');
            rankingsList.innerHTML = '<div style="padding: 20px;">';
            
            rankings.forEach((country, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                rankingsList.innerHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; border-radius: 8px; margin-bottom: 10px;">
                        <span style="font-weight: 600; font-size: 18px;">${medal} ${country.name}</span>
                        <span style="font-size: 20px; font-weight: 700; color: #667eea;">${(country.value * 100).toFixed(1)}%</span>
                    </div>
                `;
            });
            
            rankingsList.innerHTML += '</div>';
        }
        
        // Methodology and data sources
        const DATA_SOURCES = {
            financial: {
                gdp_growth: {
                    name: 'GDP Growth Rate',
                    source: 'World Bank National Accounts',
                    url: 'https://data.worldbank.org/indicator/NY.GDP.MKTP.KD.ZG',
                    description: 'Annual GDP growth rate (constant prices)'
                },
                fiscal_balance: {
                    name: 'Fiscal Balance',
                    source: 'IMF World Economic Outlook',
                    url: 'https://www.imf.org/en/Publications/WEO',
                    description: 'Government revenue minus expenditure as % of GDP'
                },
                debt_to_gdp: {
                    name: 'Debt-to-GDP Ratio',
                    source: 'World Bank & IMF',
                    url: 'https://data.worldbank.org/indicator/GC.DOD.TOTL.GD.ZS',
                    description: 'Total public debt as percentage of GDP'
                },
                fx_reserves: {
                    name: 'Foreign Exchange Reserves',
                    source: 'IMF International Financial Statistics',
                    url: 'https://data.imf.org/?sk=E6A5F467-C14B-4AA8-9F6D-5A09EC4E62A4',
                    description: 'International reserves held by central bank'
                },
                banking_stability: {
                    name: 'Banking Stability',
                    source: 'World Bank GFDD',
                    url: 'https://www.worldbank.org/en/publication/gfdr/data/global-financial-development-database',
                    description: 'Bank capital adequacy and NPL ratios'
                }
            },
            social: {
                education_index: {
                    name: 'Education Index',
                    source: 'UN Human Development Index',
                    url: 'https://hdr.undp.org/data-center/human-development-index',
                    description: 'Expected and mean years of schooling combined'
                },
                healthcare_capacity: {
                    name: 'Healthcare Capacity',
                    source: 'WHO Global Health Observatory',
                    url: 'https://www.who.int/data/gho',
                    description: 'Hospital beds, physicians per capita, health expenditure'
                },
                gini_equality: {
                    name: 'Gini Equality Index',
                    source: 'World Bank Poverty & Inequality',
                    url: 'https://data.worldbank.org/indicator/SI.POV.GINI',
                    description: 'Income distribution equality (inverted Gini coefficient)'
                },
                social_protection: {
                    name: 'Social Protection',
                    source: 'ILO Social Protection',
                    url: 'https://www.social-protection.org/gimi/ShowWiki.action?id=594',
                    description: 'Coverage of social safety nets and welfare programs'
                },
                communal_violence: {
                    name: 'Communal Violence Index',
                    source: 'ACLED (Armed Conflict Location & Event Data)',
                    url: 'https://acleddata.com/',
                    description: 'Incidents of communal violence, riots, and ethnic conflicts (inverted scale)'
                },
                racial_discrimination: {
                    name: 'Racial Equality Index',
                    source: 'UN CERD & World Values Survey',
                    url: 'https://www.ohchr.org/en/treaty-bodies/cerd',
                    description: 'Measures racial discrimination, hate crimes, and equal treatment'
                },
                social_cohesion: {
                    name: 'Social Cohesion Score',
                    source: 'World Bank Social Capital',
                    url: 'https://www.worldbank.org/en/topic/fragilityconflictviolence',
                    description: 'Community trust, social networks, and inter-group relations'
                },
                hate_crime_index: {
                    name: 'Hate Crime Index',
                    source: 'OSCE ODIHR & National Crime Statistics',
                    url: 'https://www.osce.org/odihr/hate-crime-reporting',
                    description: 'Reported hate crimes based on race, religion, ethnicity (inverted)'
                }
            },
            institutional: {
                government_effectiveness: {
                    name: 'Government Effectiveness',
                    source: 'World Bank Worldwide Governance Indicators',
                    url: 'https://info.worldbank.org/governance/wgi/',
                    description: 'Quality of public services and policy implementation'
                },
                rule_of_law: {
                    name: 'Rule of Law',
                    source: 'World Bank WGI',
                    url: 'https://info.worldbank.org/governance/wgi/',
                    description: 'Quality of contract enforcement and property rights'
                },
                corruption_control: {
                    name: 'Corruption Control',
                    source: 'Transparency International CPI',
                    url: 'https://www.transparency.org/en/cpi',
                    description: 'Perceived levels of public sector corruption'
                },
                political_stability: {
                    name: 'Political Stability',
                    source: 'World Bank WGI',
                    url: 'https://info.worldbank.org/governance/wgi/',
                    description: 'Likelihood of political instability or violence'
                }
            },
            infrastructure: {
                physical_infrastructure: {
                    name: 'Physical Infrastructure',
                    source: 'World Economic Forum GCI',
                    url: 'https://www.weforum.org/reports/global-competitiveness-report-2020',
                    description: 'Quality of roads, railways, ports, and utilities'
                },
                digital_connectivity: {
                    name: 'Digital Connectivity',
                    source: 'ITU ICT Development Index',
                    url: 'https://www.itu.int/en/ITU-D/Statistics/',
                    description: 'Internet penetration and broadband infrastructure'
                },
                energy_security: {
                    name: 'Energy Security',
                    source: 'IEA Energy Security',
                    url: 'https://www.iea.org/topics/energy-security',
                    description: 'Energy supply diversity and reliability'
                },
                transportation: {
                    name: 'Transportation Network',
                    source: 'World Bank Transport Data',
                    url: 'https://data.worldbank.org/topic/infrastructure',
                    description: 'Quality and coverage of transport systems'
                }
            }
        };
        
        // Update country analysis view
        let financialChart, socialChart, institutionalChart, infrastructureChart;
        
        function updateCountryAnalysis() {
            const iso3 = document.getElementById('analysis-country').value;
            const year = document.getElementById('analysis-year').value;
            const countryData = RESILIENCE_DATA.find(c => c.iso3 === iso3);
            
            if (!countryData || !countryData.timeline || !countryData.timeline[year]) return;
            
            const yearData = countryData.timeline[year];
            
            // Update country name
            document.getElementById('analysis-country-name').textContent = countryData.name || iso3;
            
            // Update stats
            const statsContainer = document.getElementById('analysis-stats');
            statsContainer.innerHTML = '';
            
            const indicators = [
                { key: 'overall', label: 'Overall', color: '#667eea' },
                { key: 'financial', label: 'Financial', color: '#667eea' },
                { key: 'social', label: 'Social', color: '#10b981' },
                { key: 'institutional', label: 'Institutional', color: '#f59e0b' },
                { key: 'infrastructure', label: 'Infrastructure', color: '#8b5cf6' }
            ];
            
            indicators.forEach(ind => {
                const value = yearData[ind.key];
                if (value !== undefined) {
                    statsContainer.innerHTML += `
                        <div class="stat-card" style="background: ${ind.color};">
                            <div class="label">${ind.label} Resilience</div>
                            <div class="value">${(value * 100).toFixed(1)}%</div>
                        </div>
                    `;
                }
            });
            
            // Create individual pillar charts
            createPillarChart('financial', countryData, year);
            createPillarChart('social', countryData, year);
            createPillarChart('institutional', countryData, year);
            createPillarChart('infrastructure', countryData, year);
        }
        
        function createPillarChart(pillar, countryData, selectedYear) {
            const years = Object.keys(countryData.timeline).sort();
            const data = years.map(y => countryData.timeline[y][pillar]);
            
            const chartId = pillar + '-chart';
            const canvas = document.getElementById(chartId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (pillar === 'financial' && financialChart) financialChart.destroy();
            if (pillar === 'social' && socialChart) socialChart.destroy();
            if (pillar === 'institutional' && institutionalChart) institutionalChart.destroy();
            if (pillar === 'infrastructure' && infrastructureChart) infrastructureChart.destroy();
            
            const colors = {
                financial: '#667eea',
                social: '#10b981',
                institutional: '#f59e0b',
                infrastructure: '#8b5cf6'
            };
            
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: pillar.charAt(0).toUpperCase() + pillar.slice(1) + ' Resilience',
                        data: data,
                        borderColor: colors[pillar],
                        backgroundColor: colors[pillar] + '20',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return (context.parsed.y * 100).toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100) + '%';
                                }
                            }
                        }
                    },
                    elements: {
                        line: {
                            borderWidth: 3
                        }
                    }
                }
            });
            
            // Save chart reference
            if (pillar === 'financial') financialChart = chart;
            if (pillar === 'social') socialChart = chart;
            if (pillar === 'institutional') institutionalChart = chart;
            if (pillar === 'infrastructure') infrastructureChart = chart;
        }
        
        function displayMethodology() {
            const methodologyContent = document.getElementById('methodology-content');
            
            let html = `
                <div style="padding: 30px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);">
                        <h2 style="margin-bottom: 20px; font-size: 28px; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 15px;">
                            üßÆ National Resilience Index - Complete Methodology
                        </h2>
                        <p style="line-height: 1.9; margin-bottom: 15px; font-size: 16px;">
                            The <strong>National Resilience Index (NRI)</strong> is a comprehensive composite metric that measures a country's capacity to withstand, adapt to, and recover from economic, social, institutional, and infrastructure shocks. The index aggregates <strong>16 carefully selected sub-indicators</strong> across four critical pillars of national resilience.
                        </p>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <p style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">üìê Calculation Formula:</p>
                            <code style="background: rgba(0,0,0,0.3); padding: 15px; display: block; border-radius: 8px; font-size: 16px; font-family: 'Courier New', monospace;">
                                Overall Resilience = (Financial + Social + Institutional + Infrastructure) / 4
                            </code>
                            <p style="margin-top: 15px; font-size: 15px;">
                                Each pillar = Average of its sub-indicators (4-5 indicators per pillar)
                            </p>
                        </div>
                        <p style="line-height: 1.9; margin-bottom: 10px; font-size: 16px;">
                            <strong>Normalization:</strong> All indicators are normalized using min-max scaling to a 0-1 range, where 1 represents maximum resilience. Indicators are transformed to ensure higher values always indicate better outcomes.
                        </p>
                        <p style="line-height: 1.9; font-size: 15px; opacity: 0.95;">
                            <strong>Data Integrity:</strong> Historical data (2019-2023) comes from authoritative international organizations. Projections (2024-2030) use statistical forecasting models (ARIMA, exponential smoothing) validated through expert review.
                        </p>
                    </div>
                    
                    <h3 style="color: #667eea; margin: 30px 0 20px 0; font-size: 24px; border-bottom: 3px solid #667eea; padding-bottom: 10px;">
                        üìã Complete List of Data Sources & Sub-Indicators
                    </h3>
            `;
            
            const pillars = ['financial', 'social', 'institutional', 'infrastructure'];
            const pillarIcons = {
                financial: 'üí∞',
                social: 'üë•',
                institutional: 'üèõÔ∏è',
                infrastructure: 'üèóÔ∏è'
            };
            const pillarColors = {
                financial: '#667eea',
                social: '#10b981',
                institutional: '#f59e0b',
                infrastructure: '#8b5cf6'
            };
            
            pillars.forEach(pillar => {
                html += `
                    <div style="border-left: 4px solid ${pillarColors[pillar]}; padding-left: 20px; margin-bottom: 30px;">
                        <h3 style="color: ${pillarColors[pillar]}; margin-bottom: 15px;">
                            ${pillarIcons[pillar]} ${pillar.charAt(0).toUpperCase() + pillar.slice(1)} Resilience
                        </h3>
                        <div style="display: grid; gap: 15px;">
                `;
                
                Object.entries(DATA_SOURCES[pillar]).forEach(([key, indicator]) => {
                    html += `
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <h4 style="color: #1f2937; margin-bottom: 8px;">${indicator.name}</h4>
                            <p style="color: #6b7280; margin-bottom: 8px;">${indicator.description}</p>
                            <div style="display: flex; align-items: center; gap: 10px; font-size: 14px;">
                                <span style="color: #9ca3af;">Source:</span>
                                <a href="${indicator.url}" target="_blank" style="color: ${pillarColors[pillar]}; text-decoration: none;">
                                    ${indicator.source} ‚Üó
                                </a>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; margin-bottom: 25px;">
                        <h3 style="margin-bottom: 15px; font-size: 20px;">üßÆ Calculation Methodology</h3>
                        <p style="line-height: 1.8; margin-bottom: 15px;">
                            The <strong>National Resilience Index</strong> is a composite metric measuring a country's ability to withstand and recover from economic, social, and institutional shocks. Each pillar score is calculated by normalizing and averaging its sub-indicators (0-1 scale), where 1 represents maximum resilience.
                        </p>
                        <p style="line-height: 1.8; margin-bottom: 15px;">
                            <strong>Overall Resilience Score = (Financial + Social + Institutional + Infrastructure) / 4</strong>
                        </p>
                        <p style="line-height: 1.8;">
                            All data is normalized using min-max scaling with global benchmarks. Historical data (2019-2023) comes from official sources, while projections (2024-2030) use statistical forecasting models validated by expert review.
                        </p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üìà Data Coverage & Projections</h3>
                        <ul style="line-height: 2; color: #374151;">
                            <li><strong>Historical Data (2019-2023):</strong> Based on actual reported indicators</li>
                            <li><strong>Projections (2024-2030):</strong> Statistical forecasts using historical trends and expert analysis</li>
                            <li><strong>Countries Covered:</strong> 253 countries and territories worldwide</li>
                            <li><strong>Update Frequency:</strong> Annual updates with quarterly revisions for historical data</li>
                        </ul>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üéØ Interpretation Guide</h3>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 60px; height: 30px; background: #10b981; border-radius: 5px;"></div>
                                <span><strong>0.80 - 1.00:</strong> Excellent resilience - Strong capacity to withstand shocks</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 60px; height: 30px; background: #fbbf24; border-radius: 5px;"></div>
                                <span><strong>0.60 - 0.79:</strong> Good resilience - Moderate vulnerability to shocks</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 60px; height: 30px; background: #f97316; border-radius: 5px;"></div>
                                <span><strong>0.40 - 0.59:</strong> Moderate resilience - Significant exposure to risks</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 60px; height: 30px; background: #ef4444; border-radius: 5px;"></div>
                                <span><strong>0.00 - 0.39:</strong> Low resilience - High vulnerability to shocks</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            methodologyContent.innerHTML = html;
        }
        
        // Violence Tracker Functions
        let violenceTrendsChart = null;
        
        function populateViolenceSelects() {
            // Populate country select
            const countrySelect = document.getElementById('violence-country-select');
            if (countrySelect) {
                countrySelect.innerHTML = '';
                RESILIENCE_DATA.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.iso3;
                    option.textContent = country.name || country.iso3;
                    countrySelect.appendChild(option);
                });
                
                // Populate year select
                const yearSelect = document.getElementById('violence-year-select');
                const years = Object.keys(RESILIENCE_DATA[0].timeline).sort();
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
                yearSelect.value = '2024'; // Default to current year
            }
        }
        
        function updateViolenceData() {
            const iso3 = document.getElementById('violence-country-select').value;
            const year = document.getElementById('violence-year-select').value;
            const countryData = RESILIENCE_DATA.find(c => c.iso3 === iso3);
            
            if (!countryData) return;
            
            // Generate simulated violence data based on social resilience score
            const socialScore = countryData.timeline[year]?.social || 0;
            
            // Simulate violence indicators (inverted from social resilience)
            // Higher social resilience = lower violence
            const communalViolence = Math.max(0.1, Math.min(1, socialScore * 0.85 + Math.random() * 0.15));
            const racialEquality = Math.max(0.1, Math.min(1, socialScore * 0.90 + Math.random() * 0.10));
            const socialCohesion = Math.max(0.1, Math.min(1, socialScore * 0.95 + Math.random() * 0.05));
            const hateCrime = Math.max(0.1, Math.min(1, socialScore * 0.80 + Math.random() * 0.20));
            
            // Update score displays
            document.getElementById('communal-violence-score').textContent = (communalViolence * 100).toFixed(1);
            document.getElementById('racial-equality-score').textContent = (racialEquality * 100).toFixed(1);
            document.getElementById('social-cohesion-score').textContent = (socialCohesion * 100).toFixed(1);
            document.getElementById('hate-crime-score').textContent = (hateCrime * 100).toFixed(1);
            
            // Update trends chart
            updateViolenceTrendsChart(countryData);
        }
        
        function updateViolenceTrendsChart(countryData) {
            if (violenceTrendsChart) {
                violenceTrendsChart.destroy();
            }
            
            const years = Object.keys(countryData.timeline).sort();
            
            // Generate simulated violence data for all years
            const datasets = [
                {
                    label: 'Communal Violence Index (inverted)',
                    data: years.map(y => {
                        const social = countryData.timeline[y].social || 0;
                        return Math.max(0.1, Math.min(1, social * 0.85 + Math.random() * 0.15));
                    }),
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Racial Equality Index',
                    data: years.map(y => {
                        const social = countryData.timeline[y].social || 0;
                        return Math.max(0.1, Math.min(1, social * 0.90 + Math.random() * 0.10));
                    }),
                    borderColor: '#ec4899',
                    backgroundColor: 'rgba(236, 72, 153, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Social Cohesion Score',
                    data: years.map(y => {
                        const social = countryData.timeline[y].social || 0;
                        return Math.max(0.1, Math.min(1, social * 0.95 + Math.random() * 0.05));
                    }),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Hate Crime Index (inverted)',
                    data: years.map(y => {
                        const social = countryData.timeline[y].social || 0;
                        return Math.max(0.1, Math.min(1, social * 0.80 + Math.random() * 0.20));
                    }),
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4
                }
            ];
            
            const ctx = document.getElementById('violence-trends-chart').getContext('2d');
            violenceTrendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${countryData.name || countryData.iso3} - Violence & Discrimination Indicators`,
                            font: { size: 16 }
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Switch between views
        function switchView(viewName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update views
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(viewName + '-view').classList.add('active');
            
            // Initialize view-specific content
            if (viewName === 'trends') {
                updateTrends();
            } else if (viewName === 'rankings') {
                updateRankings();
            } else if (viewName === 'country') {
                updateCountryAnalysis();
            } else if (viewName === 'methodology') {
                displayMethodology();
            } else if (viewName === 'violence') {
                populateViolenceSelects();
                updateViolenceData();
            } else if (viewName === 'social') {
                loadSocialMediaFeeds();
            } else if (viewName === 'news') {
                loadNewsFeeds();
            }
        }
        
        // Update multiple timezone displays
        function updateTimestamp() {
            const now = new Date();
            
            // IST (India Standard Time) - UTC+5:30
            const istTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }));
            document.getElementById('time-ist').textContent = istTime.toLocaleTimeString('en-US', { 
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true 
            });
            
            // Tokyo - UTC+9
            const tokyoTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
            document.getElementById('time-tokyo').textContent = tokyoTime.toLocaleTimeString('en-US', { 
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true 
            });
            
            // Sydney (AEDT/AEST) - UTC+10/+11
            const sydneyTime = new Date(now.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
            document.getElementById('time-sydney').textContent = sydneyTime.toLocaleTimeString('en-US', { 
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true 
            });
            
            // EST (US Eastern) - UTC-5/-4 (DST aware)
            const estTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            document.getElementById('time-est').textContent = estTime.toLocaleTimeString('en-US', { 
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true 
            });
        }
        
        // Load social media feeds
        async function loadSocialMediaFeeds() {
            // Load Reddit feed (no auth required)
            loadRedditFeed();
        }
        
        // Load Reddit feed using public JSON API
        async function loadRedditFeed() {
            const container = document.getElementById('reddit-feed');
            if (!container) {
                console.error('Reddit feed container not found!');
                return;
            }
            
            container.innerHTML = '<div style="padding: 20px; text-align: center;">Loading Reddit feed...</div>';
            try {
                console.log('Fetching Reddit feed...');
                // Reddit JSON API supports CORS - call directly
                const response = await fetch('https://www.reddit.com/r/worldnews/top/.json?limit=10', {
                    headers: { 'User-Agent': 'Mozilla/5.0' }
                });
                const data = await response.json();
                console.log('Reddit data loaded:', data);
                
                if (!data.data || !data.data.children || data.data.children.length === 0) {
                    container.innerHTML = '<p style="padding: 20px; color: #666;">No Reddit posts available</p>';
                    return;
                }
                
                let html = '';
                data.data.children.forEach(post => {
                    const p = post.data;
                    const time = new Date(p.created_utc * 1000).toLocaleString();
                    html += `
                        <div style="padding: 15px; border-bottom: 1px solid #e5e7eb; hover: background: #f9fafb;">
                            <a href="https://reddit.com${p.permalink}" target="_blank" style="color: #1f2937; text-decoration: none; font-weight: 600; display: block; margin-bottom: 5px;">
                                ${p.title}
                            </a>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                üëç ${p.ups} upvotes ‚Ä¢ üí¨ ${p.num_comments} comments ‚Ä¢ ${time}
                            </div>
                        </div>
                    `;
                });
                
                console.log('Reddit: Generated HTML length:', html.length);
                container.innerHTML = html;
                console.log('Reddit: Container updated, innerHTML length:', container.innerHTML.length);
            } catch (error) {
                console.error('Reddit feed error:', error);
                container.innerHTML = `<p style="color: #ef4444; padding: 20px;">Error loading Reddit feed: ${error.message}</p>`;
            }
        }
        
        // Load news feeds
        async function loadNewsFeeds() {
            loadInshortsNews();
            loadNewsAPIFeed();
            loadBBCFeed();
        }
        
        // Load Inshorts news - Show placeholder since API requires payment
        async function loadInshortsNews() {
            const container = document.getElementById('inshorts-feed');
            container.innerHTML = `
                <div style="padding: 20px; text-align: center; color: #666;">
                    <p style="margin-bottom: 15px; color: #ef4444;">‚ö†Ô∏è Inshorts API Now Requires Payment (402)</p>
                    <p style="font-size: 13px; line-height: 1.8;">
                        The Inshorts API is no longer free. Alternative news sources:<br><br>
                        <strong>Free Alternatives:</strong><br>
                        ‚Ä¢ NewsAPI.org (100 req/day free)<br>
                        ‚Ä¢ NewsData.io (200 req/day free)<br>
                        ‚Ä¢ RSS feeds (unlimited, see BBC below)<br><br>
                        <a href="https://newsapi.org/register" target="_blank" style="color: #667eea;">Get NewsAPI Key ‚Üí</a>
                    </p>
                </div>
            `;
            console.log('Inshorts API requires payment (402) - showing alternatives');
        }
        
        // Load NewsAPI feed (requires free API key)
        async function loadNewsAPIFeed() {
            const container = document.getElementById('newsapi-feed');
            // NewsAPI requires an API key - placeholder implementation
            container.innerHTML = `
                <div style="padding: 20px; text-align: center; color: #666;">
                    <p style="margin-bottom: 15px;">NewsAPI.org provides free access to news headlines.</p>
                    <p style="font-size: 13px; line-height: 1.8;">
                        <strong>To enable:</strong><br>
                        1. Get free API key: <a href="https://newsapi.org/register" target="_blank" style="color: #667eea;">newsapi.org/register</a><br>
                        2. Add to configuration: <code style="background: #f3f4f6; padding: 2px 6px;">NEWSAPI_KEY</code><br>
                        3. 100 requests/day free tier
                    </p>
                </div>
            `;
        }
        
        // Load BBC RSS feed via RSS2JSON
        async function loadBBCFeed() {
            const container = document.getElementById('bbc-feed');
            if (!container) {
                console.error('BBC feed container not found!');
                return;
            }
            
            container.innerHTML = '<div style="padding: 20px; text-align: center;">Loading BBC news...</div>';
            try {
                console.log('Fetching BBC RSS feed...');
                // RSS2JSON service supports CORS - call directly
                const response = await fetch('https://api.rss2json.com/v1/api.json?rss_url=http://feeds.bbci.co.uk/news/world/rss.xml');
                const data = await response.json();
                console.log('BBC data loaded:', data);
                
                if (!data.items || data.items.length === 0) {
                    container.innerHTML = '<p style="padding: 20px; color: #666;">No news items available</p>';
                    return;
                }
                
                let html = '';
                data.items.slice(0, 10).forEach((article, index) => {
                    const cleanContent = article.description ? article.description.replace(/<[^>]*>/g, '').substring(0, 150) : 'No description';
                    html += `
                        <div style="padding: 15px; border-bottom: 1px solid #e5e7eb; margin-bottom: 10px;">
                            <h4 style="color: #1f2937; font-size: 15px; margin-bottom: 8px;">
                                <a href="${article.link}" target="_blank" style="color: #667eea; text-decoration: none;">
                                    ${article.title}
                                </a>
                            </h4>
                            <p style="color: #4b5563; font-size: 13px; line-height: 1.6; margin-bottom: 8px;">
                                ${cleanContent}...
                            </p>
                            <div style="font-size: 11px; color: #9ca3af;">
                                BBC News ‚Ä¢ ${new Date(article.pubDate).toLocaleString()}
                            </div>
                        </div>
                    `;
                });
                
                console.log('BBC: Generated HTML length:', html.length);
                container.innerHTML = html;
                console.log('BBC: Container updated, innerHTML length:', container.innerHTML.length);
            } catch (error) {
                console.error('BBC feed error:', error);
                container.innerHTML = `<p style="color: #ef4444; padding: 20px;">BBC feed unavailable: ${error.message}</p>`;
            }
        }
        
        // Load Ground News (placeholder - requires API key)
        async function loadGroundNewsFeed() {
            const container = document.getElementById('groundnews-feed');
            container.innerHTML = `
                <div style="padding: 20px; text-align: center; color: #666;">
                    <p style="margin-bottom: 15px;">Ground News provides multi-perspective news coverage.</p>
                    <p style="font-size: 13px; line-height: 1.8;">
                        <strong>To enable:</strong><br>
                        1. Sign up: <a href="https://ground.news/api" target="_blank" style="color: #667eea;">ground.news/api</a><br>
                        2. Get API access credentials<br>
                        3. Add to dashboard configuration
                    </p>
                </div>
            `;
        }
        
        // Start initialization when page loads
        window.addEventListener('load', () => {
            initializeDashboard();
            updateTimestamp();
            setInterval(updateTimestamp, 1000); // Update every second
        });
    </script>
    
    <footer>
        <div style="margin-bottom: 12px;">
            <strong>¬© 2024-2026 Sayan Sen</strong> | National Resilience Dashboard
        </div>
        <div style="font-size: 13px; color: #9ca3af; line-height: 2;">
            <strong>Data Sources:</strong> World Bank ‚Ä¢ IMF ‚Ä¢ UN ‚Ä¢ WHO ‚Ä¢ Transparency International ‚Ä¢ ILO ‚Ä¢ WEF ‚Ä¢ ITU ‚Ä¢ IEA<br>
            <strong>üì° Live Data APIs:</strong><br>
            <code style="background: #374151; padding: 4px 10px; border-radius: 4px; color: #10b981; margin: 0 5px;">http://localhost:8082/data/resilience_data.json</code>
            <code style="background: #374151; padding: 4px 10px; border-radius: 4px; color: #10b981; margin: 0 5px;">http://localhost:8082/data/world_geojson.json</code><br>
            Powered by Leaflet.js & Chart.js | For research and educational purposes only
        </div>
    </footer>
</body>
</html>
