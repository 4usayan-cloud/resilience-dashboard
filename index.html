<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Global Resilience Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; font-family: Arial, sans-serif; }
        body { display: flex; flex-direction: column; }
        header { background: #0066cc; color: white; padding: 15px 20px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 20px; }
        header p { margin: 5px 0 0 0; font-size: 12px; opacity: 0.9; }
        .info-btn { background: white; color: #0066cc; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .info-btn:hover { background: #f0f0f0; }
        .wrapper { display: flex; flex: 1; position: relative; }
        #map { flex: 1; }
        .sidebar { width: 320px; background: white; border-left: 1px solid #ccc; overflow-y: auto; padding: 15px; }
        .sidebar h2 { font-size: 14px; color: #0066cc; margin-bottom: 10px; }
        .score-box { background: #f0f8ff; padding: 10px; border-radius: 4px; margin: 8px 0; border-left: 3px solid #0066cc; }
        .score-label { font-size: 10px; color: #666; margin-bottom: 3px; }
        .score-value { font-size: 20px; font-weight: bold; color: #0066cc; }
        .pillar { font-size: 11px; margin: 5px 0; padding: 6px; background: #f9f9f9; border-radius: 3px; }
        .pillar-val { font-weight: bold; color: #0066cc; }
        .legend { background: #f9f9f9; padding: 10px; border-radius: 4px; margin-top: 15px; font-size: 11px; }
        .legend-row { margin: 4px 0; }
        .legend-color { display: inline-block; width: 12px; height: 10px; margin-right: 5px; border: 1px solid #333; }
        .default { color: #999; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 8px; padding: 20px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .modal-close { float: right; cursor: pointer; font-size: 20px; font-weight: bold; color: #999; }
        .modal-close:hover { color: #333; }
        .modal h2 { color: #0066cc; margin-bottom: 15px; margin-top: 0; }
        .modal h3 { color: #0066cc; margin-top: 15px; margin-bottom: 8px; font-size: 13px; }
        .modal p { font-size: 12px; line-height: 1.5; margin-bottom: 10px; color: #333; }
        .pillar-card { background: #f9f9f9; padding: 10px; border-radius: 4px; margin: 8px 0; border-left: 3px solid #0066cc; }
        .pillar-card strong { color: #0066cc; }
    </style>
</head>
<body>
<header>
    <div>
        <h1>üåç Global Resilience Dashboard</h1>
        <p>296 countries ‚Ä¢ Click to view detailed scores</p>
    </div>
    <button class="info-btn" onclick="showMethodology()">‚ÑπÔ∏è Info</button>
</header>

<div class="wrapper">
    <div id="map"></div>
    <div class="sidebar">
        <h2>Country Details</h2>
        <div id="sidebar-content">
            <p class="default">Click any country on the map.</p>
            <div class="legend">
                <div style="font-weight:bold;margin-bottom:5px;">Color Scale:</div>
                <div class="legend-row"><span class="legend-color" style="background:#228b22;"></span><b>Green</b> 0.65+</div>
                <div class="legend-row"><span class="legend-color" style="background:#ffff00;"></span><b>Yellow</b> 0.45-0.65</div>
                <div class="legend-row"><span class="legend-color" style="background:#ff8c00;"></span><b>Orange</b> 0.30-0.45</div>
                <div class="legend-row"><span class="legend-color" style="background:#dc143c;"></span><b>Red</b> &lt;0.30</div>
            </div>
        </div>
    </div>
</div>

<div id="methodology-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeMethodology()">&times;</span>
        <h2>Methodology & Data</h2>
        
        <h3>üéØ Overall Score</h3>
        <p>Average of four resilience pillars (Financial, Social, Institutional, Infrastructure). Normalized to 0-1 scale where 0.5 = global average.</p>
        
        <h3>üìä Normalization Method</h3>
        <p><strong>Z-Score ‚Üí Percentile:</strong> Raw World Bank indicators are converted to z-scores, then mapped to cumulative normal distribution (CDF) percentiles. This produces scores where 0.5 is the global median and values represent relative global standing.</p>
        
        <h3>üí∞ Financial Resilience (18% Green)</h3>
        <div class="pillar-card">
            <strong>Indicators:</strong> GDP per capita, Tax revenue %, Gross savings %
            <p style="margin-top:5px;"><strong>Why lower?</strong> Many countries lack consistent tax collection and savings infrastructure. This pillar depends on economic development metrics that vary significantly worldwide.</p>
        </div>
        
        <h3>üë• Social Resilience (47% Green)</h3>
        <div class="pillar-card">
            <strong>Indicators:</strong> Life expectancy, Primary enrollment %, Health spending per capita
            <p style="margin-top:5px;"><strong>Moderate distribution:</strong> Health and education progress vary by region; wealthier countries dominate top percentiles.</p>
        </div>
        
        <h3>üèõÔ∏è Institutional Resilience (38% Green)</h3>
        <div class="pillar-card">
            <strong>Indicators:</strong> Control of Corruption, Government Effectiveness, Political Stability
            <p style="margin-top:5px;"><strong>Governance challenges:</strong> Based on World Governance Indicators (WGI). Many countries struggle with corruption and institutional capacity.</p>
        </div>
        
        <h3>üåê Infrastructure Resilience (54% Green)</h3>
        <div class="pillar-card">
            <strong>Indicators:</strong> Electricity access %, Internet users %, Water access %
            <p style="margin-top:5px;"><strong>Why highest?</strong> These are coverage metrics that hit saturation in many countries. Once electricity/water are nearly universal (95%+), further improvements are marginal. This creates higher scores globally compared to financial indicators where variation is wide.</p>
        </div>
        
        <h3>üìà Data Source & Period</h3>
        <p><strong>Source:</strong> World Bank Open Data API (15 indicators across 4 pillars)</p>
        <p><strong>Historical:</strong> 2016-2022 (latest available data)</p>
        <p><strong>Forecast:</strong> 2023-2025 (BSTS+DFM model with mean reversion)</p>
        <p><strong>Countries:</strong> 296 with sufficient data</p>
        
        <h3>üîÑ How to Read Scores</h3>
        <p><strong>0.65+:</strong> Top 25% - Advanced resilience across multiple dimensions</p>
        <p><strong>0.45-0.65:</strong> Middle 50% - Average global resilience</p>
        <p><strong>0.30-0.45:</strong> Below average - Emerging challenges</p>
        <p><strong>&lt;0.30:</strong> Critical - Urgent development needs</p>
    </div>
</div>

<script>
console.log('=== RESILIENCE MAP ===');

let countriesData = {};

// Initialize map
const map = L.map('map').setView([20, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
}).addTo(map);

function getColor(score) {
    if (!score) return '#ddd';
    if (score < 0.30) return '#dc143c';
    if (score < 0.45) return '#ff8c00';
    if (score < 0.65) return '#ffff00';
    return '#228b22';
}

function showCountry(country) {
    const html = `
        <div class="score-box">
            <div class="score-label">OVERALL RESILIENCE</div>
            <div class="score-value">${country.score.toFixed(3)}</div>
        </div>
        <div class="pillar"><b>üí∞ Financial:</b> <span class="pillar-val">${country.financial.toFixed(3)}</span></div>
        <div class="pillar"><b>üë• Social:</b> <span class="pillar-val">${country.social.toFixed(3)}</span></div>
        <div class="pillar"><b>üèõÔ∏è Institutional:</b> <span class="pillar-val">${country.institutional.toFixed(3)}</span></div>
        <div class="pillar"><b>üåê Infrastructure:</b> <span class="pillar-val">${country.infrastructure.toFixed(3)}</span></div>
    `;
    document.getElementById('sidebar-content').innerHTML = html;
}

function showMethodology() {
    document.getElementById('methodology-modal').classList.add('show');
}

function closeMethodology() {
    document.getElementById('methodology-modal').classList.remove('show');
}

// Load countries data
console.log('Loading countries_full.json...');
fetch('countries_full.json')
    .then(r => {
        console.log('Response:', r.status);
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
    })
    .then(data => {
        countriesData = data;
        console.log('‚úì Loaded', Object.keys(countriesData).length, 'countries');
        console.log('Sample USA:', countriesData['USA']);
        
        // Load and render GeoJSON
        console.log('Loading world.geojson...');
        return fetch('world.geojson');
    })
    .then(r => {
        console.log('GeoJSON response:', r.status);
        if (!r.ok) throw new Error('GeoJSON HTTP ' + r.status);
        return r.json();
    })
    .then(geojson => {
        console.log('‚úì GeoJSON loaded:', geojson.features.length, 'features');
        
        let colored = 0, uncolored = 0;
        
        L.geoJSON(geojson, {
            style: (feature) => {
                const iso = feature.properties.ISO_A3;
                const country = countriesData[iso];
                const score = country ? country.score : null;
                
                if (score) colored++;
                else uncolored++;
                
                return {
                    fillColor: getColor(score),
                    weight: 0.5,
                    opacity: 1,
                    color: '#555',
                    fillOpacity: 0.8
                };
            },
            onEachFeature: (feature, layer) => {
                const iso = feature.properties.ISO_A3;
                const country = countriesData[iso];
                
                if (country) {
                    layer.bindPopup('<b>' + country.name + '</b><br>Score: ' + country.score.toFixed(3));
                    layer.on('click', () => {
                        console.log('Clicked:', country.name);
                        showCountry(country);
                    });
                }
            }
        }).addTo(map);
        
        console.log('‚úì Map rendered -', colored, 'colored,', uncolored, 'uncolored');
    })
    .catch(err => {
        console.error('ERROR:', err);
        document.getElementById('sidebar-content').innerHTML = '<div style="color:red;"><b>Error:</b> ' + err.message + '</div>';
    });
</script>
</body>
</html>
